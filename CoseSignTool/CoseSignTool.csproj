<Project Sdk="Microsoft.NET.Sdk">
    <!--Build configuration-->
    <PropertyGroup>
        <OutputType>Exe</OutputType>
        <TargetFramework>net8.0</TargetFramework>
        <RuntimeIdentifiers>win-x64;linux-x64;osx-x64;osx-arm64;</RuntimeIdentifiers>
        <Platforms>AnyCPU</Platforms>
    </PropertyGroup>

    <!--Plugin deployment: enabled by default, use -p:NoPlugins=true to disable-->
    <PropertyGroup>
        <DeployPlugins Condition="'$(NoPlugins)' != 'true'">true</DeployPlugins>
        <DeployPlugins Condition="'$(NoPlugins)' == 'true'">false</DeployPlugins>
    </PropertyGroup>

    <!--Consolidated plugin discovery - reused by all plugin targets-->
    <ItemGroup Condition="'$(DeployPlugins)' == 'true'">
        <PluginProjects Include="$(MSBuildProjectDirectory)\..\**\*.Plugin.csproj" />
        <PluginNames Include="@(PluginProjects->'%(Filename)')" />
    </ItemGroup>

    <!--Single-file publishing configuration for self-contained deployments
        Plugins are embedded in the single-file and extracted on first run.
        AppContext.BaseDirectory points to the extraction location where plugins are available.-->
    <PropertyGroup Condition="'$(PublishSingleFile)' == 'true'">
        <SelfContained>true</SelfContained>
        <PublishSingleFile>true</PublishSingleFile>
        <IncludeNativeLibrariesForSelfExtract>true</IncludeNativeLibrariesForSelfExtract>
        <IncludeAllContentForSelfExtract>true</IncludeAllContentForSelfExtract>
        <EnableCompressionInSingleFile>true</EnableCompressionInSingleFile>
    </PropertyGroup>

    <!--Code style and static analysis-->
    <PropertyGroup>
        <Nullable>enable</Nullable>
        <EnforceCodeStyleInBuild>true</EnforceCodeStyleInBuild>
        <EnableNETAnalyzers>true</EnableNETAnalyzers>
        <AnalysisLevel>latest</AnalysisLevel>
        <TreatWarningsAsErrors>true</TreatWarningsAsErrors>
    </PropertyGroup>

    <!--Strong name signing-->
    <PropertyGroup>
        <SignAssembly>True</SignAssembly>
        <PublicSign>True</PublicSign>
        <AssemblyOriginatorKeyFile>..\StrongNameKeys\35MSSharedLib1024.snk</AssemblyOriginatorKeyFile>
    </PropertyGroup>

    <!--NuGet package configuration-->
    <PropertyGroup>
        <PackageId>$(MsBuildProjectName)</PackageId>
        <PackageVersion>$(VersionNgt)</PackageVersion>
        <Company>Microsoft</Company>
        <PackageLicenseFile>LICENSE</PackageLicenseFile>
        <PackageRequireLicenseAcceptance>false</PackageRequireLicenseAcceptance>
        <PackageReadmeFile>readme.md</PackageReadmeFile>
        <PackageReleaseNotes>ChangeLog.md</PackageReleaseNotes>
        <Description>Command line tool to sign files using COSE Sign1 message envelopes in a way that is compatible with Supply Chain Integrity Transparency and Trust (SCITT).</Description>
        <PackAsTool>true</PackAsTool>
        <ToolCommandName>CoseSignTool</ToolCommandName>
        <IncludeBuildOutput>true</IncludeBuildOutput>
    </PropertyGroup>

    <!--Internals for testing-->
    <ItemGroup>
        <AssemblyAttribute Include="System.Runtime.CompilerServices.InternalsVisibleToAttribute">
            <_Parameter1>CoseSignTool.Tests, PublicKey=0024000004800000940000000602000000240000525341310004000001000100b5fc90e7027f67871e773a8fde8938c81dd402ba65b9201d60593e96c492651e889cc13f1415ebb53fac1131ae0bd333c5ee6021672d9718ea31a8aebd0da0072f25d87dba6fc90ffd598ed4da35e44c398c454307e8e33b8426143daec9f596836f97c8f74750e5975c64e2189f45def46b2a2b1247adc3652bf5c308055da9</_Parameter1>
        </AssemblyAttribute>
    </ItemGroup>

    <!--Package references-->
    <ItemGroup>
        <PackageReference Include="Microsoft.Extensions.Configuration.CommandLine" />
    </ItemGroup>

    <!--Project references-->
    <ItemGroup>
        <ProjectReference Include="..\CoseHandler\CoseHandler.csproj" />
        <ProjectReference Include="..\CoseSign1.Certificates\CoseSign1.Certificates.csproj" />
        <ProjectReference Include="..\CoseSign1.Headers\CoseSign1.Headers.csproj" />
        <ProjectReference Include="..\CoseSign1.Transparent.MST\CoseSign1.Transparent.MST.csproj" />
        <ProjectReference Include="..\CoseSignTool.Abstractions\CoseSignTool.Abstractions.csproj" />
    </ItemGroup>

    <!--Files to include in the package-->
    <ItemGroup>
        <None Include="..\LICENSE" Pack="true" PackagePath="\" />
        <None Include="..\readme.md" Pack="true" PackagePath="\" />
        <None Include="..\ChangeLog.md" Pack="true" PackagePath="\" />
        <None Include="..\docs\*.md" Pack="true" PackagePath="\docs\" />
        <None Include="\bin\Release\net8.0\_manifest\spdx_2.2\*.*" Condition="Exists('\bin\Release\net8.0\_manifest\spdx_2.2\*.*')" Pack="true" PackagePath="Build\sbom\spdx_2.2" />
    </ItemGroup>

    <!--Reusable plugin deployment template-->
    <Target Name="DeployPlugin">
        <PropertyGroup>
            <PluginsDir>$(OutputPath)plugins</PluginsDir>
            <PluginSubDir>$(PluginsDir)\$(PluginName)</PluginSubDir>
            <!-- Handle both RID-specific and non-RID builds -->
            <PluginSourceDir Condition="'$(RuntimeIdentifier)' != ''">$(MSBuildProjectDirectory)\..\$(PluginName)\bin\$(Configuration)\net8.0\$(RuntimeIdentifier)</PluginSourceDir>
            <PluginSourceDir Condition="'$(RuntimeIdentifier)' == ''">$(MSBuildProjectDirectory)\..\$(PluginName)\bin\$(Configuration)\net8.0</PluginSourceDir>
        </PropertyGroup>
        
        <MakeDir Directories="$(PluginSubDir)" />
        
        <!-- Get all plugin files for subdirectory isolation -->
        <ItemGroup>
            <AllPluginFiles Include="$(PluginSourceDir)\*.dll;$(PluginSourceDir)\*.exe;$(PluginSourceDir)\*.xml;$(PluginSourceDir)\*.pdb;$(PluginSourceDir)\*.json;$(PluginSourceDir)\*.runtimeconfig.json" />
        </ItemGroup>
        
        <!-- For subdirectory isolation: Copy ALL plugin files to create self-contained plugin directories -->
        <!-- Exclude only .NET framework assemblies (System.*, mscorlib, netstandard, Microsoft.CSharp, etc.) to avoid duplication -->
        <ItemGroup>
            <PluginSpecificFiles Include="@(AllPluginFiles)" 
                Condition="!$([System.String]::new('%(Filename)').StartsWith('System.')) 
                    AND '%(Filename)' != 'mscorlib' 
                    AND '%(Filename)' != 'netstandard' 
                    AND '%(Filename)' != 'Microsoft.CSharp' 
                    AND '%(Filename)' != 'WindowsBase' 
                    AND '%(Filename)' != 'Microsoft.VisualBasic' 
                    AND '%(Filename)' != 'Microsoft.VisualBasic.Core' 
                    AND '%(Filename)' != 'Microsoft.Win32.Primitives' 
                    AND '%(Filename)' != 'Microsoft.Win32.Registry'" />
        </ItemGroup>
        
        <Copy SourceFiles="@(PluginSpecificFiles)" DestinationFolder="$(PluginSubDir)" Condition="Exists('$(PluginSourceDir)')" SkipUnchangedFiles="true" />
        
        <Message Text="Plugin '$(PluginName)' deployed to: $(PluginSubDir)" Importance="high" Condition="Exists('$(PluginSourceDir)')" />
        <Message Text="Copied @(PluginSpecificFiles->Count()) plugin-specific files for subdirectory isolation" Importance="high" Condition="'@(PluginSpecificFiles)' != ''" />
        <Warning Text="Plugin directory not found at: $(PluginSourceDir)" Condition="!Exists('$(PluginSourceDir)')" />
    </Target>

    <!--Automatic plugin discovery and deployment - runs by default unless NoPlugins=true-->
    <Target Name="DeployAllPlugins" AfterTargets="Build" Condition="'$(DeployPlugins)' == 'true'">
        <!-- Deploy each discovered plugin using consolidated PluginNames ItemGroup -->
        <MSBuild Projects="$(MSBuildProjectFile)" 
                 Properties="PluginName=%(PluginNames.Identity);Configuration=$(Configuration);RuntimeIdentifier=$(RuntimeIdentifier)" 
                 Targets="DeployPlugin" 
                 Condition="'@(PluginNames)' != ''" />
        
        <Message Text="Deployed @(PluginNames->Count()) plugin(s): @(PluginNames, ', ')" Importance="high" Condition="'@(PluginNames)' != ''" />
        <Warning Text="No plugin projects found (looking for *.Plugin.csproj)" Condition="'@(PluginNames)' == ''" />
    </Target>

    <!--Include deployed plugins as Content for single-file bundling-->
    <Target Name="IncludePluginsInPublish" AfterTargets="DeployAllPlugins" BeforeTargets="_ComputeFilesToBundle" Condition="'$(DeployPlugins)' == 'true' AND '$(PublishSingleFile)' == 'true'">
        <PropertyGroup>
            <PluginsSourcePath>$(OutputPath)plugins</PluginsSourcePath>
        </PropertyGroup>
        
        <!-- Discover all deployed plugin files -->
        <ItemGroup>
            <PluginFilesToBundle Include="$(PluginsSourcePath)\**\*.*" Condition="Exists('$(PluginsSourcePath)')" />
        </ItemGroup>
        
        <!-- Add plugin files to the single-file bundle -->
        <ItemGroup>
            <FilesToBundle Include="@(PluginFilesToBundle)">
                <RelativePath>plugins\%(RecursiveDir)%(Filename)%(Extension)</RelativePath>
            </FilesToBundle>
        </ItemGroup>
        
        <Message Text="Including @(PluginFilesToBundle->Count()) plugin files in single-file bundle" Importance="high" Condition="'@(PluginFilesToBundle)' != ''" />
    </Target>

    <!--Clean up the plugins folder from publish output since plugins are bundled in the single-file exe-->
    <Target Name="CleanupPluginsFolderForSingleFile" AfterTargets="Publish" Condition="'$(PublishSingleFile)' == 'true' AND '$(DeployPlugins)' == 'true'">
        <RemoveDir Directories="$(PublishDir)plugins" Condition="Exists('$(PublishDir)plugins')" />
        <Message Text="Removed plugins folder from publish output (plugins are bundled in single-file exe)" Importance="high" />
    </Target>

    <!--Build all plugins before main build so they're ready for deployment-->
    <Target Name="BuildPlugins" BeforeTargets="Build" Condition="'$(DeployPlugins)' == 'true'">
        <!-- Build each plugin project using consolidated PluginProjects ItemGroup -->
        <Message Text="Building @(PluginProjects->Count()) plugin project(s)..." Importance="high" Condition="'@(PluginProjects)' != ''" />
        <MSBuild Projects="@(PluginProjects)" Properties="Configuration=$(Configuration);RuntimeIdentifier=$(RuntimeIdentifier)" Condition="'@(PluginProjects)' != ''" />
    </Target>
</Project>
